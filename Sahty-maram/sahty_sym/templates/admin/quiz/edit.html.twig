{% extends 'admin/base.html.twig' %}

{% block title %}Modifier le Quiz{% endblock %}

{% block body %}
<style>
    .quiz-form-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 40px;
        color: #fff;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
    }

    .quiz-form-container h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .quiz-form-container .form-subtitle {
        font-size: 1.1rem;
        opacity: 0.95;
        margin-bottom: 30px;
    }

    .quiz-form-section {
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        display: block;
    }

    .form-control, .form-select {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px 15px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    .quiz-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    @media (max-width: 768px) {
        .quiz-info-grid {
            grid-template-columns: 1fr;
        }
    }

    .question-card {
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .question-card:hover {
        border-color: #667eea;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
    }

    .question-card.has-error {
        border-color: #dc3545;
        background: #fff5f5;
    }

    .question-header {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .question-header {
            grid-template-columns: 1fr;
        }
    }

    .question-text-area {
        display: flex;
        flex-direction: column;
    }

    .question-text-area textarea {
        min-height: 120px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .question-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .question-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
    }

    .btn-remove-question {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-remove-question:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 87, 108, 0.3);
    }

    .btn-add-question {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        margin-bottom: 30px;
    }

    .btn-add-question:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(79, 172, 254, 0.3);
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        padding-top: 20px;
    }

    .btn-submit-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 35px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-submit-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .btn-submit-secondary {
        background: #e0e0e0;
        border: none;
        color: #333;
        padding: 12px 35px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-submit-secondary:hover {
        background: #d0d0d0;
        transform: translateY(-3px);
    }

    .form-error-message {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .empty-questions-message {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-style: italic;
    }

    .questions-list {
        margin-bottom: 30px;
    }
</style>

<div class="container-fluid py-4">
    <div class="quiz-form-container">
        <h1>‚úèÔ∏è Modifier le Quiz</h1>
        <p class="form-subtitle">Mettez √† jour les d√©tails et les questions du quiz</p>
    </div>

    <div class="quiz-form-section">
        {{ form_start(form) }}

        <!-- Infos g√©n√©rales du quiz -->
        <h5 class="section-title">üìã Informations du Quiz</h5>
        
        <div class="quiz-info-grid">
            <div class="form-group">
                {{ form_label(form.name, 'Nom du quiz') }}
                {{ form_widget(form.name, {'attr': {'class': 'form-control', 'placeholder': 'Ex: G√©om√©trie 101'}}) }}
                {% if form.name.vars.errors|length > 0 %}
                    <div class="form-error-message">
                        ‚ö†Ô∏è {{ form.name.errors[0].message }}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form_label(form.description, 'Description') }}
                {{ form_widget(form.description, {'attr': {'class': 'form-control', 'placeholder': 'D√©crivez le contenu du quiz'}}) }}
                {% if form.description.vars.errors|length > 0 %}
                    <div class="form-error-message">
                        ‚ö†Ô∏è {{ form.description.errors[0].message }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Questions -->
    <div class="quiz-form-section">
        <h5 class="section-title">‚ùì Questions</h5>
        
        <div class="questions-list" data-prototype="{{ form_widget(form.questions.vars.prototype)|e('html_attr') }}" data-widget-counter="{{ form.questions|length }}">
            {% if form.questions|length > 0 %}
                {% for question in form.questions %}
                    <div class="question-card {% if question.vars.errors|length > 0 %}has-error{% endif %}">
                        {% if question.vars.errors|length > 0 %}
                            <div class="form-error-message" style="margin-bottom: 15px;">
                                ‚ö†Ô∏è Erreurs d√©tect√©es
                            </div>
                        {% endif %}

                        <div class="question-header">
                            <div class="question-text-area">
                                {{ form_label(question.text, 'Texte de la question') }}
                                {{ form_widget(question.text, {'attr': {'class': 'form-control', 'placeholder': '√âcrivez votre question ici...'}}) }}
                                {% if question.text.vars.errors|length > 0 %}
                                    <div class="form-error-message">
                                        ‚ö†Ô∏è {{ question.text.errors[0].message }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="question-meta">
                            <div class="form-group">
                                {{ form_label(question.type, 'Type') }}
                                {{ form_widget(question.type, {'attr': {'class': 'form-select'}}) }}
                                {% if question.type.vars.errors|length > 0 %}
                                    <div class="form-error-message">
                                        ‚ö†Ô∏è {{ question.type.errors[0].message }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                {{ form_label(question.category, 'Cat√©gorie') }}
                                {{ form_widget(question.category, {'attr': {'class': 'form-select'}}) }}
                                {% if question.category.vars.errors|length > 0 %}
                                    <div class="form-error-message">
                                        ‚ö†Ô∏è {{ question.category.errors[0].message }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                {{ form_label(question.orderInQuiz, 'Ordre') }}
                                {{ form_widget(question.orderInQuiz, {'attr': {'class': 'form-control', 'type': 'number'}}) }}
                                {% if question.orderInQuiz.vars.errors|length > 0 %}
                                    <div class="form-error-message">
                                        ‚ö†Ô∏è {{ question.orderInQuiz.errors[0].message }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                {{ form_label(question.reverse, 'Inverser') }}
                                {{ form_widget(question.reverse, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                        </div>

                        <div class="question-actions">
                            <button type="button" class="btn-remove-question" data-question-id="{{ loop.index0 }}">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-questions-message">
                    Aucune question pour le moment. Cliquez sur "Ajouter une question" pour commencer.
                </div>
            {% endif %}
        </div>

        <button type="button" class="btn-add-question">‚ûï Ajouter une question</button>
    </div>

    <!-- Actions -->
    <div class="quiz-form-section">
        <div class="form-actions">
            <a href="{{ path('admin_quiz_index') }}" class="btn-submit-secondary">Annuler</a>
            <button type="submit" class="btn-submit-primary">üíæ Modifier le Quiz</button>
        </div>
    </div>

    {{ form_end(form) }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const collectionHolder = document.querySelector('.questions-list');
    const addButton = document.querySelector('.btn-add-question');
    let index = collectionHolder.dataset.widgetCounter;

    // Fonction pour ajouter les √©v√©nements aux boutons de suppression
    function addDeleteListeners() {
        document.querySelectorAll('.btn-remove-question').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                this.closest('.question-card').remove();
            });
        });
    }

    // Ajouter bouton pour nouvelles questions
    addButton.addEventListener('click', function (e) {
        e.preventDefault();
        const prototype = collectionHolder.dataset.prototype;
        const item = prototype.replace(/__name__/g, index);
        
        const wrapper = document.createElement('div');
        wrapper.innerHTML = item;
        const newCard = wrapper.querySelector('.question-card') || wrapper.firstElementChild;
        
        if (!newCard.classList.contains('question-card')) {
            newCard.classList.add('question-card');
        }

        // Ensure prototype controls have the same styling as existing cards
        (function styleFields(root) {
            if (!root) return;
            root.querySelectorAll('textarea').forEach(t => t.classList.add('form-control'));
            root.querySelectorAll('select').forEach(s => s.classList.add('form-select'));
            root.querySelectorAll('input[type="text"], input[type="number"]').forEach(i => i.classList.add('form-control'));
            root.querySelectorAll('input[type="checkbox"]').forEach(c => c.classList.add('form-check-input'));
            root.querySelectorAll('label').forEach(lb => lb.classList.add('form-label'));
        })(newCard);

        collectionHolder.appendChild(newCard);
        index++;
        collectionHolder.dataset.widgetCounter = index;
        
        addDeleteListeners();
    });

    // Ajouter les listeners initiaux
    addDeleteListeners();
});
</script>
{% endblock %}