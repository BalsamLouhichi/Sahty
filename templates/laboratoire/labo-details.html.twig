{# templates/labo/labo-details.html.twig #}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>MEDINOVA - Détails du Laboratoire</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    {# Favicon #}
    <link href="{{ asset('img/favicon.ico') }}" rel="icon">

    {# Google Web Fonts #}
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    {# Icons #}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    {# Bootstrap + Template CSS #}
    <link href="{{ asset('css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ asset('css/style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">

    <style>
        .labo-header{
            background: linear-gradient(rgba(29, 42, 77, 0.9), rgba(29, 42, 77, 0.9)), url('{{ asset("img/lab-banner.jpg") }}');
            background-size: cover;
            background-position: center;
        }
        .labo-details-card{
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .labo-main-image{
            height: 400px;
            width: 100%;
            object-fit: cover;
        }
        .labo-info-box{
            background: var(--light);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .labo-icon{
            width: 60px; height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display:flex; align-items:center; justify-content:center;
            margin-right: 15px;
            color:#fff;
            font-size: 24px;
        }

        /* Protocol Styles */
        .protocol-section{
            background: var(--light);
            border-radius: 15px;
            padding: 40px;
        }
        .protocol-offer{
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
        }
        .offer-badge{
            background: var(--primary);
            color:#fff;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 15px;
        }
        .protocol-grid{
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .protocol-item{
            background: #fff;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: transform 0.3s;
        }
        .protocol-item:hover{ transform: translateX(5px); }
        .protocol-category{
            color: var(--secondary);
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.05rem;
        }
        .protocol-methods{
            display:flex;
            flex-wrap:wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .method-badge{
            background: var(--light);
            color: var(--dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .method-badge.biology{ background: #e3f2fd; color:#1565c0; }
        .method-badge.anamnese{ background: #f3e5f5; color:#7b1fa2; }

        .appointment-box{
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color:#fff;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }
        .contact-info{
            background:#fff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .contact-info i{
            color: var(--primary);
            font-size: 24px;
            margin-right: 15px;
        }
        
        .test-mode-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: #ffc107;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .test-mode-info {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 0 5px 5px 0;
            margin-bottom: 20px;
        }
        
        /* Styles pour le select des médecins */
        .medecin-search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        
        .medecin-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            z-index: 3;
        }
        
        .medecin-count {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .medecin-option {
            padding: 8px 12px;
        }
        
        .medecin-specialite {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }

        .header-map-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 12px;
            padding: 10px;
        }

        .header-map {
            width: 100%;
            height: 360px;
            border-radius: 10px;
        }

        .map-note {
            color: #ffffff;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        @media (max-width: 768px){
            .protocol-grid{ grid-template-columns: 1fr; }
            .labo-main-image{ height: 250px; }
            .header-map{ height: 260px; }
        }
    </style>
</head>

<body>

{# ✅ Topbar + Navbar (ton include) #}
{% include 'partials/header.html.twig' %}

{# ===========================
   Header (dynamique)
   =========================== #}
<div class="container-fluid labo-header py-5 mb-5">
    <div class="container py-5">
        <div class="row align-items-center">
            <div class="col-lg-7">

                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent p-0 mb-3">
                        <li class="breadcrumb-item">
                            <a href="{{ path('app_home') }}" class="text-white">Accueil</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{{ path('app_labo_index') }}" class="text-white">Laboratoires</a>
                        </li>
                        <li class="breadcrumb-item text-white active" aria-current="page">
                            {{ laboratoire.nom }}
                        </li>
                    </ol>
                </nav>

                <h1 class="display-2 text-white mb-4">{{ laboratoire.nom }}</h1>

                <p class="text-white fs-5 mb-4">
                    {{ laboratoire.description ?? 'Services de diagnostic complets avec équipement de pointe et pathologistes experts.' }}
                </p>

                <div class="d-flex flex-wrap align-items-center gap-4">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-map-marker-alt text-primary fs-4 me-2"></i>
                        <span class="text-white">
                            {{ laboratoire.adresse ?? 'Adresse non renseignée' }}
                            {% if laboratoire.ville is defined and laboratoire.ville %} - {{ laboratoire.ville }}{% endif %}
                        </span>
                    </div>

                    <div class="d-flex align-items-center">
                        <i class="fa fa-phone-alt text-primary fs-4 me-2"></i>
                        <span class="text-white">{{ laboratoire.telephone ?? 'Téléphone non renseigné' }}</span>
                    </div>

                    {% if laboratoire.disponible is defined %}
                        <div class="d-flex align-items-center">
                            <i class="fa fa-check-circle text-primary fs-4 me-2"></i>
                            <span class="text-white">
                                {% if laboratoire.disponible %}Disponible{% else %}Indisponible{% endif %}
                            </span>
                        </div>
                    {% endif %}
                </div>

            </div>

            <div class="col-lg-5 mt-4 mt-lg-0">
                {% if laboratoire.latitude is not null and laboratoire.longitude is not null %}
                    <div class="header-map-card">
                        <div id="laboratoire-map" class="header-map"></div>
                        <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                            <div class="map-note">
                                Position GPS: {{ laboratoire.latitude }}, {{ laboratoire.longitude }}
                            </div>
                            <a
                                class="btn btn-sm btn-light"
                                target="_blank"
                                rel="noopener noreferrer"
                                href="https://www.google.com/maps?q={{ laboratoire.latitude }},{{ laboratoire.longitude }}"
                            >
                                Ouvrir Maps
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="header-map-card text-white">
                        Coordonnees GPS non disponibles pour ce laboratoire.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# ===========================
   Content
   =========================== #}
<div class="container-fluid py-5">
    <div class="container">
        <div class="row g-5">

            {# ---------- Main content ---------- #}
            <div class="col-lg-8">

                {# Image #}
                <div class="labo-details-card mb-5">
                    {# Si tu ajoutes un champ imagePath dans BDD, remplace par laboratoire.imagePath #}
                    <img src="{{ asset('img/lab-detail-1.jpg') }}" class="labo-main-image" alt="Laboratoire">
                </div>

                {# About #}
                <div class="labo-details-card p-5 mb-5">
                    <h2 class="mb-4">À Propos</h2>

                    <p class="mb-4">
                        {{ laboratoire.description
                            ?? "Ce laboratoire propose des services de tests médicaux avec des standards de qualité élevés." }}
                    </p>

                    <div class="row g-4 mt-4">
                        <div class="col-md-6">
                            <div class="labo-info-box">
                                <div class="d-flex align-items-center">
                                    <div class="labo-icon"><i class="fa fa-microscope"></i></div>
                                    <div>
                                        <h5 class="mb-2">Équipement Avancé</h5>
                                        <p class="mb-0">Analysateurs de dernière génération</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="labo-info-box">
                                <div class="d-flex align-items-center">
                                    <div class="labo-icon"><i class="fa fa-user-md"></i></div>
                                    <div>
                                        <h5 class="mb-2">Équipe Expert</h5>
                                        <p class="mb-0">Techniciens et biologistes qualifiés</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="labo-info-box">
                                <div class="d-flex align-items-center">
                                    <div class="labo-icon"><i class="fa fa-bolt"></i></div>
                                    <div>
                                        <h5 class="mb-2">Résultats Rapides</h5>
                                        <p class="mb-0">Délais optimisés selon le test</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="labo-info-box">
                                <div class="d-flex align-items-center">
                                    <div class="labo-icon"><i class="fa fa-shield-alt"></i></div>
                                    <div>
                                        <h5 class="mb-2">Qualité & Sécurité</h5>
                                        <p class="mb-0">Procédures contrôlées et traçabilité</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {# ✅ ===========================
                   Protocol section (DYNAMIQUE)
                   =========================== #}
                <div class="protocol-section mb-5">
                    <div class="text-center mb-5">
                        <h5 class="d-inline-block text-primary text-uppercase border-bottom border-5">Protocole Médical</h5>
                        <h1 class="display-6 mb-3">Nos Évaluations de Santé Complètes</h1>
                        <p class="mb-0">Les bilans proposés par ce laboratoire (depuis la base de données).</p>
                    </div>

                    {% if analysesParCategorie is not defined or analysesParCategorie is empty %}
                        <div class="alert alert-warning mb-0">
                            Aucune analyse n’est encore associée à ce laboratoire.
                            <br>
                            (Ajoute des lignes dans <strong>laboratoire_type_analyse</strong>.)
                        </div>
                    {% else %}
                        {% for categorie, types in analysesParCategorie %}

                            <div class="protocol-offer">
                                <div class="offer-badge"
                                     style="{% if categorie == 'Zoi Pulse' %}background: var(--secondary);{% endif %}">
                                    {{ categorie }}
                                </div>

                                <h3 class="mb-3">
                                    {% if categorie == 'Zoi Life' %}
                                        Forfait d'Évaluation de Santé Complète
                                    {% elseif categorie == 'Zoi Pulse' %}
                                        Forfait de Diagnostic Avancé
                                    {% else %}
                                        Analyses - {{ categorie }}
                                    {% endif %}
                                </h3>

                                <div class="protocol-grid">
                                    {% for t in types %}
                                        <div class="protocol-item">
                                            <div class="protocol-category">{{ t.nom }}</div>

                                            {# Optionnel: si tu as description dans TypeAnalyse #}
                                            {% if t.description is defined and t.description %}
                                                <div class="text-muted small">{{ t.description }}</div>
                                            {% endif %}

                                            <div class="protocol-methods">
                                                <span class="method-badge biology">Biologie</span>
                                                {# Si tu ajoutes une colonne "necessiteAnamnese" par ex:
                                                   {% if t.necessiteAnamnese %}<span class="method-badge anamnese">Anamnèse</span>{% endif %}
                                                #}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>

                                <div class="text-center mt-4">
                                    <a href="#appointment" class="btn btn-primary btn-lg px-5">
                                        Réserver - {{ categorie }}
                                    </a>
                                </div>
                            </div>

                        {% endfor %}
                    {% endif %}
                </div>

                {# Services (tu peux rendre dynamique plus tard) #}
                <div class="labo-details-card p-5">
                    <h2 class="mb-4">Services Proposés</h2>
                    <p class="text-muted mb-4">
                        (Optionnel : tu peux aussi afficher ici toutes les analyses, ou filtrer par catégories médicales.)
                    </p>

                    {% if analysesParCategorie is defined and analysesParCategorie is not empty %}
                        <div class="row">
                            <div class="col-12">
                                <ul class="list-unstyled mb-0">
                                    {% for categorie, types in analysesParCategorie %}
                                        <li class="mb-3">
                                            <strong>{{ categorie }}</strong>
                                            <div class="d-flex flex-wrap gap-2 mt-2">
                                                {% for t in types %}
                                                    <span class="badge bg-light text-dark border">
                                                        {{ t.nom }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">Aucun service/aucune analyse configuré(e) pour le moment.</p>
                    {% endif %}
                </div>

            </div>

            {# ---------- Sidebar ---------- #}
            <div class="col-lg-4">

                {# Appointment Box #}
                <div class="appointment-box" id="appointment">
                    <h3 class="text-white mb-4">Réserver Votre Test</h3>
                    <p class="text-white mb-4">
                        Planifiez vos tests de laboratoire en ligne.
                    </p>

                    {% set responsableInactif = laboratoire.responsable is defined and laboratoire.responsable and not laboratoire.responsable.estActif %}
                    {% set laboIndisponible = laboratoire.disponible is defined and not laboratoire.disponible %}
                    {% set reservationBloquee = responsableInactif or laboIndisponible %}

                    {% if app.user %}
                        {% if reservationBloquee %}
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-ban me-2"></i>
                                {% if laboIndisponible %}
                                    Ce laboratoire est actuellement indisponible.
                                {% endif %}
                                Vous ne pouvez pas reserver de test pour le moment.
                            </div>
                        {% else %}
                    <form method="post" action="{{ path('app_demande_analyse_new_for_lab', {'laboratoireId': laboratoire.id}) }}">
                        
                        {# Nom complet #}
                        {#<div class="mb-3">
                            <label class="form-label text-white">Nom complet *</label>
                            <input type="text" class="form-control" name="nom" 
                                placeholder="Votre Nom" required>
                        </div>

                        {# Téléphone #}
                        {# <div class="mb-3">
                            <label class="form-label text-white">Téléphone *</label>
                            <input type="tel" class="form-control" name="telephone" 
                                placeholder="Ex: 06123456" 
                                pattern="[0-9]{8}" 
                                title="8 chiffres sans espaces" 
                                required>
                        </div>

                        {# Email #}
                        {# <div class="mb-3">
                            <label class="form-label text-white">Email *</label>
                            <input type="email" class="form-control" name="email" 
                                placeholder="votre@email.com" required>
                        </div>

                        {# ✅ NOUVEAU : Médecin prescripteur (optionnel) depuis la BDD #}
                        <div class="mb-3">
                            <label class="form-label text-white">
                                Médecin prescripteur 
                                <span class="text-white-50">(optionnel)</span>
                            </label>
                            
                            {% if medecins is defined and medecins|length > 0 %}
                                
                                
                                <select class="form-select" name="medecin_id" id="medecin_select">
                                    <option value="" selected class="medecin-option">Aucun médecin</option>
                                    {% for medecin in medecins %}
                                        <option value="{{ medecin.id }}" 
                                                class="medecin-option"
                                                data-nom="{{ medecin.nomComplet|lower }}"
                                                data-specialite="{{ medecin.specialite|default('')|lower }}">
                                            Dr. {{ medecin.nomComplet }}
                                            {% if medecin.specialite is defined and medecin.specialite %}
                                                <span class="medecin-specialite"> - {{ medecin.specialite }}</span>
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-white-50 medecin-count">
                                        <i class="fas fa-user-md me-1"></i>
                                        {{ medecins|length }} médecin(s) disponible(s)
                                    </small>
                                    <small class="text-white-50">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Optionnel
                                    </small>
                                </div>
                            {% else %}
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Aucun médecin disponible dans la base de données.
                                </div>
                                <input type="hidden" name="medecin_id" value="">
                            {% endif %}
                        </div>

                        {# Type d'analyse #}
                        <div class="mb-3">
                            <label class="form-label text-white">Type d'analyse *</label>
                            <select class="form-select" name="type_analyse" id="type_analyse" required>
                                <option value="" selected disabled>Sélectionner une analyse</option>
                                {% if analysesDetailsParCategorie is defined and analysesDetailsParCategorie is not empty %}
                                    {% for categorie, analyses in analysesDetailsParCategorie %}
                                        <optgroup label="{{ categorie }}">
                                            {% for analyse in analyses %}
                                                {% set typeAnalyse = analyse.type_analyse %}
                                                {% set disponible = analyse.disponible %}
                                                {% set prix = analyse.prix %}
                                                {% set delai = analyse.delai %}
                                                
                                                <option value="{{ typeAnalyse.nom }}" 
                                                    {% if not disponible %}disabled{% endif %}
                                                    data-prix="{{ prix }}"
                                                    data-delai="{{ delai }}"
                                                    data-disponible="{{ disponible ? 'true' : 'false' }}">
                                                    {{ typeAnalyse.nom }}
                                                    {% if prix %}({{ prix }}€){% endif %}
                                                    {% if not disponible %}[Indisponible]{% endif %}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                {% elseif analysesParCategorie is defined and analysesParCategorie is not empty %}
                                    {% for categorie, types in analysesParCategorie %}
                                        <optgroup label="{{ categorie }}">
                                            {% for t in types %}
                                                <option value="{{ t.nom }}">{{ t.nom }}</option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                {% else %}
                                    <option value="Analyse sanguine complète">Analyse sanguine complète</option>
                                    <option value="Biochimie sanguine">Biochimie sanguine</option>
                                    <option value="Test COVID-19 PCR">Test COVID-19 PCR</option>
                                    <option value="Test COVID-19 antigénique">Test COVID-19 antigénique</option>
                                    <option value="Bilan thyroïdien">Bilan thyroïdien</option>
                                {% endif %}
                            </select>
                            
                            {# Détails de l'analyse sélectionnée #}
                            <div id="analyse-details" class="mt-2 p-2 bg-white rounded" style="display: none;">
                                <small>
                                    <span id="analyse-prix" class="badge bg-success me-2"></span>
                                    <span id="analyse-delai" class="badge bg-info me-2"></span>
                                    <span id="analyse-dispo" class="badge bg-danger" style="display: none;">Indisponible</span>
                                </small>
                            </div>
                        </div>

                        {# Date souhaitée #}
                        <div class="mb-3">
                            <label class="form-label text-white">Date souhaitée *</label>
                            <input type="date" class="form-control" name="date_souhaitee" 
                                id="date_souhaitee"
                                min="{{ "now"|date("Y-m-d") }}" 
                                max="{{ "now"|date_modify("+30 days")|date("Y-m-d") }}"
                                required>
                            <small class="text-white-50 d-block mt-1">Sélectionnez une date dans les 30 prochains jours</small>
                        </div>

                        {# Heure préférée #}
                        <div class="mb-3">
                            <label class="form-label text-white">Heure préférée *</label>
                            <select class="form-select" name="heure_souhaitee" required>
                                <option value="" selected disabled>Sélectionnez une heure</option>
                                {% set heures = ['08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30'] %}
                                {% for heure in heures %}
                                    <option value="{{ heure }}">{{ heure }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-white-50 d-block mt-1">Horaires d'ouverture: 08h00 - 17h00</small>
                        </div>

                        {# Notes supplémentaires #}
                        <div class="mb-3">
                            <label class="form-label text-white">Informations supplémentaires</label>
                            <textarea class="form-control" name="notes" rows="3" 
                                    placeholder="Informations importantes (allergies, traitements en cours, prescriptions médicales...)"></textarea>
                        </div>

                        {# CSRF Token #}
                        <input type="hidden" name="_token" value="{{ csrf_token('demande_analyse_new') }}">

                        <button type="submit" class="btn btn-light w-100 py-3 mt-2">
                            <i class="fa fa-calendar-check me-2"></i>Prendre Rendez-vous
                        </button>
                        
                    </form>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-lock me-2"></i>
                            Vous devez vous connecter ou vous inscrire pour reserver un test.
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            <a class="btn btn-light w-100" href="{{ path('app_login') }}">
                                Se connecter
                            </a>
                            <a class="btn btn-outline-light w-100" href="{{ path('app_sign') }}">
                                S'inscrire
                            </a>
                        </div>
                    {% endif %}
                </div>

                {# Contact Information (dynamique) #}
                <div class="contact-info mt-4">
                    <h4 class="mb-4">Informations de Contact</h4>

                    <div class="d-flex align-items-start mb-4">
                        <i class="fa fa-map-marker-alt"></i>
                        <div>
                            <h6 class="mb-1">Adresse</h6>
                            <p class="mb-0">
                                {{ laboratoire.adresse ?? 'Adresse non renseignée' }}<br>
                                {% if laboratoire.ville is defined and laboratoire.ville %}
                                    {{ laboratoire.ville }}
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <div class="d-flex align-items-start mb-4">
                        <i class="fa fa-phone-alt"></i>
                        <div>
                            <h6 class="mb-1">Téléphone</h6>
                            <p class="mb-0">{{ laboratoire.telephone ?? 'Téléphone non renseigné' }}</p>
                        </div>
                    </div>

                    <div class="d-flex align-items-start">
                        <i class="fa fa-clock"></i>
                        <div>
                            <h6 class="mb-1">Horaires</h6>
                            <p class="mb-0">
                                {{ laboratoire.horaires ?? 'Lun-Ven: 08h00-17h00, Sam: 08h00-12h00' }}
                            </p>
                        </div>
                    </div>
                </div>

                {# Emergency #}
                <div class="contact-info" style="border-color: #dc3545;">
                    <div class="d-flex align-items-start">
                        <i class="fa fa-ambulance" style="color: #dc3545;"></i>
                        <div>
                            <h6 class="mb-2 text-danger">Laboratoire d'Urgence</h6>
                            <p class="mb-2">Services d'Urgence 24h/24 et 7j/7 Disponibles</p>
                            <h5 class="text-danger mb-0">190 / SAMU</h5>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
</div>

{# Footer #}
{% include 'partials/footer.html.twig' %}

{# Back to Top #}
<a href="#!" class="btn btn-lg btn-primary btn-lg-square back-to-top">
    <i class="bi bi-arrow-up"></i>
</a>

{# JS #}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ asset('lib/easing/easing.min.js') }}"></script>
<script src="{{ asset('lib/waypoints/waypoints.min.js') }}"></script>
<script src="{{ asset('js/main.js') }}"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const laboLat = {{ laboratoire.latitude is not null ? laboratoire.latitude : 'null' }};
    const laboLng = {{ laboratoire.longitude is not null ? laboratoire.longitude : 'null' }};
    const mapContainer = document.getElementById('laboratoire-map');

    if (mapContainer && laboLat !== null && laboLng !== null && window.L) {
        const map = L.map('laboratoire-map', { scrollWheelZoom: false }).setView([laboLat, laboLng], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([laboLat, laboLng])
            .addTo(map)
            .bindPopup('<strong>{{ laboratoire.nom|e("js") }}</strong><br>{{ laboratoire.adresse|default("Adresse non renseignee")|e("js") }}')
            .openPopup();

        setTimeout(() => map.invalidateSize(), 200);
    }
    // Éléments DOM
    const selectAnalyse = document.getElementById('type_analyse');
    const detailsDiv = document.getElementById('analyse-details');
    const prixSpan = document.getElementById('analyse-prix');
    const delaiSpan = document.getElementById('analyse-delai');
    const dispoSpan = document.getElementById('analyse-dispo');
    const dateInput = document.getElementById('date_souhaitee');
    
    // Date du jour par défaut
    const today = new Date().toISOString().split('T')[0];
    if (dateInput && !dateInput.value) {
        dateInput.value = today;
    }
    
    // Afficher les détails de l'analyse sélectionnée
    if (selectAnalyse) {
        selectAnalyse.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (selectedOption.value && !selectedOption.disabled) {
                const prix = selectedOption.getAttribute('data-prix');
                const delai = selectedOption.getAttribute('data-delai');
                const disponible = selectedOption.getAttribute('data-disponible');
                
                // Effacer les détails précédents
                prixSpan.textContent = '';
                delaiSpan.textContent = '';
                dispoSpan.style.display = 'none';
                
                // Afficher les nouveaux détails
                if (prix && prix !== 'null') {
                    prixSpan.textContent = prix + '€';
                    prixSpan.style.display = 'inline-block';
                }
                
                if (delai && delai !== 'null') {
                    delaiSpan.textContent = 'Délai: ' + delai + 'h';
                    delaiSpan.style.display = 'inline-block';
                }
                
                if (disponible === 'false') {
                    dispoSpan.style.display = 'inline-block';
                }
                
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        });
    }
    
    // ✅ Recherche dynamique dans la liste des médecins
    const medecinSelect = document.getElementById('medecin_select');
    const medecinSearch = document.getElementById('medecin-search');
    
    if (medecinSelect && medecinSearch) {
        // Fonction pour filtrer les médecins
        const filterMedecins = function(searchTerm) {
            const options = medecinSelect.getElementsByTagName('option');
            let visibleCount = 0;
            searchTerm = searchTerm.toLowerCase().trim();
            
            for (let option of options) {
                if (option.value === '') {
                    // Toujours afficher "Aucun médecin"
                    option.style.display = '';
                    if (searchTerm === '') visibleCount++;
                    continue;
                }
                
                const nom = option.getAttribute('data-nom') || '';
                const specialite = option.getAttribute('data-specialite') || '';
                const text = option.textContent.toLowerCase();
                
                if (searchTerm === '' || 
                    nom.includes(searchTerm) || 
                    specialite.includes(searchTerm) ||
                    text.includes(searchTerm)) {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            }
            
            // Mettre à jour le compteur
            const countElement = document.querySelector('.medecin-count');
            if (countElement) {
                countElement.innerHTML = `<i class="fas fa-user-md me-1"></i>${visibleCount} médecin(s) correspondant(s)`;
            }
        };
        
        // Écouter les changements dans la recherche
        medecinSearch.addEventListener('input', function() {
            filterMedecins(this.value);
        });
        
        // Réinitialiser la recherche quand on change de médecin
        medecinSelect.addEventListener('change', function() {
            if (this.value === '') {
                medecinSearch.value = '';
                filterMedecins('');
            }
        });
        
        // Initialiser avec recherche vide
        filterMedecins('');
    }
    
    // Avertissement pour les dates du weekend
    if (dateInput) {
        dateInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const day = selectedDate.getDay();
            const now = new Date();
            const selectedDateTime = selectedDate.getTime();
            const nowDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            
            // Vérifier si la date est dans le passé
            if (selectedDateTime < nowDateOnly) {
                alert('⚠️ Erreur : Vous ne pouvez pas sélectionner une date passée.');
                this.value = today;
                return;
            }
            
            // Vérifier si c'est un weekend
            if (day === 0 || day === 6) {
                if (!confirm('⚠️ Ce laboratoire peut être fermé ou avoir des horaires réduits le weekend.\n\nSouhaitez-vous continuer ?')) {
                    this.value = today;
                }
            }
            
            // Vérifier si c'est aujourd'hui après 16h30
            if (selectedDateTime === nowDateOnly) {
                const nowHour = now.getHours();
                if (nowHour >= 16) {
                    if (!confirm('⚠️ Il est déjà tard. Pour aujourd\'hui, seules les heures restantes sont disponibles.\n\nSouhaitez-vous continuer ?')) {
                        // Demain par défaut
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        this.value = tomorrow.toISOString().split('T')[0];
                    }
                }
            }
        });
    }
    
    // Validation du formulaire
    const form = document.querySelector('.appointment-box form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Vérifier que tous les champs requis sont remplis
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#dc3545';
                    field.style.boxShadow = '0 0 0 0.25rem rgba(220, 53, 69, 0.25)';
                } else {
                    field.style.borderColor = '';
                    field.style.boxShadow = '';
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('⚠️ Veuillez remplir tous les champs obligatoires marqués d\'un *');
                return false;
            }
            
            // Vérifier la date
            const dateField = form.querySelector('input[name="date_souhaitee"]');
            if (dateField) {
                const selectedDate = new Date(dateField.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    e.preventDefault();
                    alert('⚠️ La date sélectionnée est passée. Veuillez choisir une date future.');
                    return false;
                }
            }
            
            // Message de confirmation
            if (!confirm('Confirmez-vous la création de cette demande d\'analyse ?')) {
                e.preventDefault();
                return false;
            }
            
            // Indicateur de chargement
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Traitement en cours...';
                submitBtn.disabled = true;
            }
            
            return true;
        });
    }
    
});
</script>

</body>
</html>
