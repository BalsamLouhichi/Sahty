{# templates/commande/confirmation.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Commande {{ commande.numero }} confirmée{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .confirmation-container {
            max-width: 1300px;
            margin: 40px auto;
        }
        
        .confirmation-card {
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            overflow: hidden;
            border: none;
        }
        
        .confirmation-header {
            background: linear-gradient(135deg, #0dcaf0 0%, #0bb6d9 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .confirmation-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .commande-numero {
            font-size: 1.8rem;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 10px 25px;
            border-radius: 50px;
            display: inline-block;
            margin: 15px 0;
        }
        
        .section-card {
            border-left: 4px solid #0dcaf0;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #0dcaf0;
            border-bottom: 2px solid #0dcaf0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .statut-badge {
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .info-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            min-width: 120px;
        }
        
        .info-value {
            color: #333;
        }
        
        .btn-print {
            background: #6c757d;
            color: white;
            border: none;
        }
        
        .btn-print:hover {
            background: #5a6268;
            color: white;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #0dcaf0;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0dcaf0;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #0dcaf0;
        }
        
        @media (max-width: 768px) {
            .confirmation-header {
                padding: 30px 20px;
            }
            
            .commande-numero {
                font-size: 1.4rem;
            }
        }
    </style>
{% endblock %}

{% block body %}


<div class="container confirmation-container">
    <div class="confirmation-card">
        <!-- En-tête de confirmation -->
        <div class="confirmation-header">
            <div class="confirmation-icon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <h1 class="display-5 fw-bold mb-3">Commande Confirmée !</h1>
            <p class="lead mb-4">Merci pour votre commande. Voici les détails :</p>
            <div class="commande-numero">
                <i class="bi bi-receipt me-2"></i>{{ commande.numero }}
            </div>
        </div>
        
        <!-- Corps de la confirmation -->
        <div class="card-body p-4 p-md-5">
            <!-- Message de succès -->
            <div class="alert alert-success mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-2">Votre commande a été enregistrée avec succès !</h5>
                        <p class="mb-0">Un email de confirmation vous a été envoyé à <strong>{{ commande.email }}</strong></p>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Colonne gauche : Détails de la commande -->
                <div class="col-lg-8">
                    <!-- Section : Résumé de la commande -->
                    <div class="card mb-4 section-card">
                        <div class="card-body">
                            <h3 class="section-title">
                                <i class="bi bi-cart me-2"></i>Détails de la commande
                            </h3>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <span class="info-label">Produit :</span>
                                        <span class="info-value fw-bold">{{ commande.produit.nom }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Quantité :</span>
                                        <span class="info-value">{{ commande.quantite }} unité(s)</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Prix unitaire :</span>
                                        <span class="info-value">{{ commande.prixUnitaire|number_format(2, ',', ' ') }} €</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <span class="info-label">Total :</span>
                                        <span class="info-value fw-bold text-success fs-5">
                                            {{ commande.prixTotal|number_format(2, ',', ' ') }} €
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Statut :</span>
                                        <span class="badge bg-{{ commande.statutCouleur }} statut-badge">
                                            {{ commande.statutLibelle }}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Paiement :</span>
                                        {% set paymentMap = {
                                            'paid': 'Paye',
                                            'pending': 'En attente',
                                            'failed': 'Echec',
                                            'not_required': 'Non requis'
                                        } %}
                                        {% set paymentColor = commande.paymentStatus == 'paid' ? 'success' : (commande.paymentStatus == 'pending' ? 'warning' : (commande.paymentStatus == 'failed' ? 'danger' : 'secondary')) %}
                                        <span class="badge bg-{{ paymentColor }} statut-badge">
                                            {{ paymentMap[commande.paymentStatus]|default(commande.paymentStatus|default('Non renseigne')) }}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Date :</span>
                                        <span class="info-value">{{ commande.dateCreation|date('d/m/Y à H:i') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section : Parapharmacie -->
                    <div class="card mb-4 section-card">
                        <div class="card-body">
                            <h3 class="section-title">
                                <i class="bi bi-shop me-2"></i>Parapharmacie
                            </h3>
                            
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <div class="bg-primary rounded-circle p-3">
                                        <i class="bi bi-shop text-white" style="font-size: 1.5rem;"></i>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="mb-2">{{ commande.parapharmacie.nom }}</h5>
                                    <p class="mb-1">
                                        <i class="bi bi-geo-alt me-2 text-muted"></i>
                                        {{ commande.parapharmacie.adresse }}
                                    </p>
                                    <p class="mb-1">
                                        <i class="bi bi-telephone me-2 text-muted"></i>
                                        {{ commande.parapharmacie.telephone }}
                                    </p>
                                    {% if commande.parapharmacie.email %}
                                        <p class="mb-0">
                                            <i class="bi bi-envelope me-2 text-muted"></i>
                                            {{ commande.parapharmacie.email }}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Colonne droite : Informations client et étapes -->
                <div class="col-lg-4">
                    <!-- Section : Informations client -->
                    <div class="card mb-4 section-card">
                        <div class="card-body">
                            <h3 class="section-title">
                                <i class="bi bi-person-circle me-2"></i>Informations client
                            </h3>
                            
                            <div class="info-item">
                                <span class="info-label d-block mb-1">Nom :</span>
                                <span class="info-value">{{ commande.nomClient }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label d-block mb-1">Email :</span>
                                <span class="info-value">{{ commande.email }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label d-block mb-1">Téléphone :</span>
                                <span class="info-value">{{ commande.telephone }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label d-block mb-1">Adresse :</span>
                                <span class="info-value">{{ commande.adresseLivraison }}</span>
                            </div>
                            
                            {% if commande.notes %}
                                <div class="mt-3 pt-3 border-top">
                                    <span class="info-label d-block mb-1">Notes :</span>
                                    <span class="info-value">{{ commande.notes }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Section : Prochaines étapes -->
                    <div class="card section-card">
                        <div class="card-body">
                            <h3 class="section-title">
                                <i class="bi bi-clock-history me-2"></i>Prochaines étapes
                            </h3>
                            
                            <div class="timeline">
                                <div class="timeline-item">
                                    <h6 class="fw-bold mb-1">1. Confirmation</h6>
                                    <p class="small text-muted mb-0">La parapharmacie vous contactera dans les 24h</p>
                                </div>
                                <div class="timeline-item">
                                    <h6 class="fw-bold mb-1">2. Préparation</h6>
                                    <p class="small text-muted mb-0">Votre commande sera préparée sous 48h</p>
                                </div>
                                <div class="timeline-item">
                                    <h6 class="fw-bold mb-1">3. Retrait</h6>
                                    <p class="small text-muted mb-0">Récupérez votre commande en pharmacie</p>
                                </div>
                                <div class="timeline-item">
                                    <h6 class="fw-bold mb-1">4. Suivi</h6>
                                    <p class="small text-muted mb-0">Consultez l'état de votre commande</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section : Informations importantes -->
            <div class="card mt-4 border-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle-fill text-info fs-3 me-3"></i>
                        <div>
                            <h5 class="mb-2">Informations importantes</h5>
                            <ul class="mb-0">
                                <li>Présentez votre numéro de commande <strong>{{ commande.numero }}</strong> lors du retrait</li>
                                <li>Vous recevrez un SMS/Email pour chaque mise à jour de statut</li>
                                <li>Pour toute question, contactez directement la parapharmacie</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="d-flex flex-wrap justify-content-center gap-3 mt-5 pt-4 border-top">
                <a href="{{ path('app_produit_details', {'id': commande.produit.id}) }}" 
                   class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-arrow-left me-2"></i>Retour au produit
                </a>
                
                {% if commande.modePaiement == 'online_btcpay' and commande.paymentStatus != 'paid' %}
                    <form method="post" action="{{ path('app_commande_payer', {'id': commande.id}) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('payer-commande-' ~ commande.id) }}">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-credit-card me-2"></i>Payer maintenant
                        </button>
                    </form>
                {% endif %}
                
                
                <button onclick="window.print()" 
                        class="btn btn-print btn-lg">
                    <i class="bi bi-printer me-2"></i>Imprimer
                </button>
            </div>
            
            <!-- Lien pour nouvelle commande -->
            <div class="text-center mt-4">
                <p class="text-muted">
                    Vous souhaitez passer une nouvelle commande ? 
                    <a href="{{ path('app_parapharmacie_list') }}" class="text-decoration-none">
                        Parcourir les produits
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ajouter un message pour l'impression
            const originalPrint = window.print;
            window.print = function() {
                if (confirm('Imprimer cette confirmation de commande ?')) {
                    originalPrint();
                }
            };
            
            // Message de bienvenue
            setTimeout(() => {
                if (!localStorage.getItem('commande_confirmation_seen')) {
                    alert('✅ Commande confirmée ! Un email de récapitulatif vous a été envoyé.');
                    localStorage.setItem('commande_confirmation_seen', 'true');
                }
            }, 500);
            
            // Animation pour les cartes
            document.querySelectorAll('.section-card').forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    card.style.transition = 'all 0.5s ease';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 100);
            });
        });
        
        // Fonction pour partager la commande
        function shareCommande() {
            const text = `Ma commande #{{ commande.numero }} chez {{ commande.parapharmacie.nom }}`;
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Ma commande',
                    text: text,
                    url: url,
                });
            } else {
                // Fallback pour les navigateurs qui ne supportent pas l'API Share
                alert('Copiez ce lien pour partager votre commande :\n\n' + url);
            }
        }
    </script>
{% endblock %}
